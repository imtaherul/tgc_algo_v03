<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Main Account</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Syne:wght@400;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #080c10;
        --surface: #0d1117;
        --border: #1e2d3d;
        --buy: #00e5a0;
        --buy-dim: #00e5a015;
        --sell: #ff4060;
        --sell-dim: #ff406015;
        --text: #c9d1d9;
        --muted: #4a5568;
        --white: #f0f6fc;
        --warn: #f0a500;
        --mono: "Share Tech Mono", monospace;
        --sans: "Syne", sans-serif;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--sans);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 20px 80px;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image:
          linear-gradient(rgba(0, 229, 160, 0.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(0, 229, 160, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        pointer-events: none;
        z-index: 0;
      }

      .wrapper {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 880px;
      }

      /* ── Header ── */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 48px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }
      .logo {
        font-family: var(--mono);
        font-size: 13px;
        color: var(--muted);
        letter-spacing: 0.1em;
      }
      .logo span {
        color: var(--buy);
      }
      h1 {
        font-size: clamp(24px, 4vw, 36px);
        font-weight: 800;
        color: var(--white);
        letter-spacing: -0.02em;
      }
      h1 em {
        font-style: normal;
        color: var(--buy);
      }
      .badge {
        font-family: var(--mono);
        font-size: 11px;
        background: var(--buy-dim);
        color: var(--buy);
        border: 1px solid var(--buy);
        padding: 4px 10px;
        border-radius: 4px;
        letter-spacing: 0.1em;
      }

      /* ── Meta strip ── */
      .meta {
        display: flex;
        gap: 20px;
        margin-bottom: 36px;
        flex-wrap: wrap;
        align-items: center;
      }
      .meta-item {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
      }
      .meta-item span {
        color: var(--text);
        margin-left: 6px;
      }

      /* shared editable meta field style */
      .meta-item.editable {
        display: flex;
        align-items: center;
        gap: 0;
      }
      .meta-item.editable .meta-lbl {
        color: var(--muted);
      }
      .meta-field-wrap {
        display: inline-flex;
        align-items: center;
        margin-left: 6px;
        border-bottom: 1px dashed var(--muted);
        transition: border-color 0.2s;
      }
      .meta-field-wrap:focus-within {
        border-color: var(--buy);
      }
      .meta-field-wrap .prefix,
      .meta-field-wrap .suffix {
        color: var(--text);
        font-family: var(--mono);
        font-size: 12px;
      }
      .meta-field-wrap .suffix {
        color: var(--muted);
        margin-left: 2px;
      }

      /* all three editable inputs: margin, tp, sl */
      .meta-field-wrap input[type="number"] {
        background: transparent;
        border: none;
        outline: none;
        color: var(--buy);
        font-family: var(--mono);
        font-size: 12px;
        width: 100px; /* ← 100px as requested */
        text-align: right;
        padding: 0;
        -moz-appearance: textfield;
        caret-color: var(--buy);
        /* override the global input styles */
        border-radius: 0 !important;
        box-shadow: none !important;
      }
      .meta-field-wrap input[type="number"]::-webkit-inner-spin-button,
      .meta-field-wrap input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
      }

      /* ── Grid ── */
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 32px;
      }
      @media (max-width: 600px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      /* ── Card ── */
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 28px;
        position: relative;
        overflow: hidden;
        transition: border-color 0.2s;
      }
      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
      }
      .card.buy::before {
        background: var(--buy);
        box-shadow: 0 0 20px var(--buy);
      }
      .card.sell::before {
        background: var(--sell);
        box-shadow: 0 0 20px var(--sell);
      }
      .card.buy:hover {
        border-color: var(--buy);
      }
      .card.sell:hover {
        border-color: var(--sell);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 24px;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .buy .dot {
        background: var(--buy);
        box-shadow: 0 0 8px var(--buy);
      }
      .sell .dot {
        background: var(--sell);
        box-shadow: 0 0 8px var(--sell);
      }
      .card-title {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.05em;
      }
      .buy .card-title {
        color: var(--buy);
      }
      .sell .card-title {
        color: var(--sell);
      }
      .card-sub {
        font-family: var(--mono);
        font-size: 11px;
        color: var(--muted);
        margin-left: auto;
      }

      /* ── Form fields ── */
      .field {
        margin-bottom: 20px;
      }
      label {
        display: block;
        font-family: var(--mono);
        font-size: 11px;
        color: var(--muted);
        letter-spacing: 0.1em;
        margin-bottom: 8px;
        text-transform: uppercase;
      }
      /* Main price input — full-width big style */
      .price-input {
        width: 100%;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--white);
        font-family: var(--mono);
        font-size: 20px;
        padding: 14px 16px;
        outline: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
        -moz-appearance: textfield;
      }
      .price-input::-webkit-inner-spin-button,
      .price-input::-webkit-outer-spin-button {
        -webkit-appearance: none;
      }
      .buy .price-input:focus {
        border-color: var(--buy);
        box-shadow: 0 0 0 3px var(--buy-dim);
      }
      .sell .price-input:focus {
        border-color: var(--sell);
        box-shadow: 0 0 0 3px var(--sell-dim);
      }

      .preview {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 14px 16px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .preview-item {
        font-family: var(--mono);
        font-size: 12px;
      }
      .preview-item .lbl {
        color: var(--muted);
        display: block;
        margin-bottom: 2px;
      }
      .preview-item .val {
        color: var(--text);
      }
      .buy .tp-val {
        color: var(--buy);
      }
      .sell .tp-val {
        color: var(--sell);
      }
      .buy .sl-val {
        color: var(--sell);
      }
      .sell .sl-val {
        color: var(--buy);
      }

      /* ── Button ── */
      button {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 8px;
        font-family: var(--sans);
        font-size: 15px;
        font-weight: 700;
        letter-spacing: 0.08em;
        cursor: pointer;
        transition:
          opacity 0.15s,
          transform 0.1s;
      }
      button:hover {
        opacity: 0.88;
      }
      button:active {
        transform: scale(0.98);
      }
      .btn-buy {
        background: var(--buy);
        color: #000;
      }
      .btn-sell {
        background: var(--sell);
        color: #fff;
      }

      /* ── Result / Error ── */
      .result-box {
        border-radius: 12px;
        padding: 24px 28px;
        margin-bottom: 28px;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-8px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .result-box.success {
        background: #0d1f17;
        border: 1px solid var(--buy);
      }
      .result-box.error {
        background: #1a0d11;
        border: 1px solid var(--sell);
      }
      .result-title {
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0.08em;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .success .result-title {
        color: var(--buy);
      }
      .error .result-title {
        color: var(--sell);
      }
      .order-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 16px;
      }
      @media (max-width: 500px) {
        .order-grid {
          grid-template-columns: 1fr;
        }
      }
      .order-cell {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px 14px;
        font-family: var(--mono);
      }
      .order-cell .lbl {
        font-size: 10px;
        color: var(--muted);
        display: block;
        margin-bottom: 4px;
        letter-spacing: 0.1em;
      }
      .order-cell .val {
        font-size: 14px;
        color: var(--white);
      }
      .log-list {
        list-style: none;
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
        border-top: 1px solid var(--border);
        padding-top: 14px;
      }
      .log-list li {
        padding: 3px 0;
      }
      .log-list li:first-child {
        color: var(--text);
      }
      .error-msg {
        font-family: var(--mono);
        font-size: 13px;
        color: var(--sell);
        word-break: break-all;
      }

      /* ══ TERMINAL ══ */
      .terminal-wrap {
        margin-top: 8px;
        margin-bottom: 40px;
      }
      .terminal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #0a0f14;
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        padding: 10px 16px;
      }
      .terminal-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.08em;
      }
      .terminal-dots {
        display: flex;
        gap: 6px;
      }
      .terminal-dots span {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .terminal-dots .d1 {
        background: #ff5f57;
      }
      .terminal-dots .d2 {
        background: #febc2e;
      }
      .terminal-dots .d3 {
        background: #28c840;
      }
      .terminal-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--buy);
        box-shadow: 0 0 6px var(--buy);
        animation: pulse 2s infinite;
      }
      .status-dot.disconnected {
        background: var(--muted);
        box-shadow: none;
        animation: none;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }
      .status-label {
        font-family: var(--mono);
        font-size: 10px;
        color: var(--muted);
      }
      .btn-clear {
        width: auto;
        padding: 4px 10px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--muted);
        font-family: var(--mono);
        font-size: 10px;
        letter-spacing: 0.08em;
        cursor: pointer;
        transition:
          color 0.15s,
          border-color 0.15s;
      }
      .btn-clear:hover {
        color: var(--text);
        border-color: var(--text);
        opacity: 1;
      }
      .terminal-body {
        background: #060a0d;
        border: 1px solid var(--border);
        border-radius: 0 0 10px 10px;
        padding: 16px;
        height: 320px;
        overflow-y: auto;
        font-family: var(--mono);
        font-size: 12.5px;
        line-height: 1.7;
        scroll-behavior: smooth;
      }
      .terminal-body::-webkit-scrollbar {
        width: 6px;
      }
      .terminal-body::-webkit-scrollbar-track {
        background: transparent;
      }
      .terminal-body::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
      .log-line {
        display: flex;
        gap: 12px;
        padding: 1px 0;
      }
      .log-ts {
        color: #2a3a4a;
        flex-shrink: 0;
        user-select: none;
      }
      .log-lvl {
        flex-shrink: 0;
        width: 52px;
        text-align: right;
      }
      .log-msg {
        color: var(--text);
        word-break: break-all;
      }
      .lvl-INFO {
        color: #4a6880;
      }
      .lvl-SUCCESS {
        color: var(--buy);
      }
      .lvl-ERROR {
        color: var(--sell);
      }
      .lvl-WARN {
        color: var(--warn);
      }
      .log-line.lvl-SUCCESS .log-msg {
        color: #a0f0d0;
      }
      .log-line.lvl-ERROR .log-msg {
        color: #ffaaaa;
      }
      .log-line.lvl-WARN .log-msg {
        color: #f0d090;
      }
      .terminal-caret {
        display: inline-block;
        width: 7px;
        height: 13px;
        background: var(--buy);
        margin-left: 4px;
        vertical-align: middle;
        animation: blink 1.1s step-end infinite;
      }
      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
      }
      .terminal-empty {
        color: var(--muted);
        font-size: 12px;
        padding: 20px 0;
      }

      footer {
        margin-top: 0;
        font-family: var(--mono);
        font-size: 11px;
        color: var(--muted);
        text-align: center;
        border-top: 1px solid var(--border);
        padding-top: 20px;
        width: 100%;
        max-width: 880px;
      }

      /* ══ OPEN ORDERS ══ */
      .orders-wrap {
        margin-bottom: 40px;
      }
      .orders-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
      }
      .orders-title {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.1em;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .orders-count {
        background: var(--buy-dim);
        color: var(--buy);
        border: 1px solid var(--buy);
        font-family: var(--mono);
        font-size: 10px;
        padding: 2px 7px;
        border-radius: 10px;
      }
      .btn-refresh {
        width: auto;
        padding: 4px 12px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--muted);
        font-family: var(--mono);
        font-size: 10px;
        letter-spacing: 0.08em;
        cursor: pointer;
        transition:
          color 0.15s,
          border-color 0.15s,
          transform 0.3s;
      }
      .btn-refresh:hover {
        color: var(--buy);
        border-color: var(--buy);
        opacity: 1;
      }
      .btn-refresh.spinning {
        transform: rotate(180deg);
      }
      .orders-empty {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--muted);
        text-align: center;
        padding: 28px;
        border: 1px dashed var(--border);
        border-radius: 10px;
      }
      .orders-table-wrap {
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
      }
      .orders-table {
        width: 100%;
        border-collapse: collapse;
      }
      .orders-table th {
        font-family: var(--mono);
        font-size: 10px;
        color: var(--muted);
        text-align: left;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        padding: 9px 14px;
        background: #0a0f14;
        border-bottom: 1px solid var(--border);
      }
      .orders-table td {
        font-family: var(--mono);
        font-size: 12px;
        color: var(--text);
        padding: 10px 14px;
        border-bottom: 1px solid #0f1923;
        vertical-align: middle;
      }
      .orders-table tr:last-child td {
        border-bottom: none;
      }
      .orders-table tbody tr:hover td {
        background: #0d1520;
      }
      .side-buy {
        color: var(--buy);
        font-weight: 700;
      }
      .side-sell {
        color: var(--sell);
        font-weight: 700;
      }
      .type-badge {
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 3px;
        background: var(--border);
        color: var(--muted);
        letter-spacing: 0.08em;
      }
      .type-badge.algo {
        background: #1a2535;
        color: var(--warn);
        border: 1px solid #2a3a4a;
      }
      .btn-cancel {
        width: auto;
        padding: 4px 10px;
        background: transparent;
        border: 1px solid var(--sell);
        border-radius: 4px;
        color: var(--sell);
        font-family: var(--mono);
        font-size: 10px;
        letter-spacing: 0.06em;
        cursor: pointer;
        transition: background 0.15s;
      }
      .btn-cancel:hover {
        background: var(--sell-dim);
        opacity: 1;
      }
      .btn-cancel:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <!-- Header -->
      <header>
        <div class="logo">BINANCE <span>FUTURES</span> / USDT-M</div>
        <h1>tgc <em>Algo</em></h1>
        <div class="badge">LIVE</div>
      </header>

      <!-- Meta strip with editable MARGIN, TP OFFSET, SL OFFSET -->
      <div class="meta">
        <div class="meta-item">SYMBOL<span>{{ cfg_symbol }}</span></div>
        <div class="meta-item">LEVERAGE<span>{{ cfg_leverage }}×</span></div>

        <!-- Editable Margin -->
        <div class="meta-item editable">
          <span class="meta-lbl">MARGIN</span>
          <div class="meta-field-wrap">
            <span class="prefix">$</span>
            <input
              type="number"
              id="meta-margin"
              value="{{ cfg_amount }}"
              min="1"
              step="1"
              oninput="onSettingChange()"
              title="Margin in USDT"
            />
            <span class="suffix">USDT</span>
          </div>
        </div>

        <!-- Editable TP Offset -->
        <div class="meta-item editable">
          <span class="meta-lbl">TP OFFSET</span>
          <div class="meta-field-wrap">
            <span class="prefix">±</span>
            <input
              type="number"
              id="meta-tp"
              value="{{ cfg_tp }}"
              min="1"
              step="1"
              oninput="onSettingChange()"
              title="Take Profit offset in USDT"
            />
          </div>
        </div>

        <!-- Editable SL Offset -->
        <div class="meta-item editable">
          <span class="meta-lbl">SL OFFSET</span>
          <div class="meta-field-wrap">
            <span class="prefix">±</span>
            <input
              type="number"
              id="meta-sl"
              value="{{ cfg_sl }}"
              min="1"
              step="1"
              oninput="onSettingChange()"
              title="Stop Loss offset in USDT"
            />
          </div>
        </div>
      </div>

      <!-- Trading Forms -->
      <div class="grid">
        <!-- BUY -->
        <div class="card buy">
          <div class="card-header">
            <div class="dot"></div>
            <div class="card-title">LONG / BUY</div>
            <div class="card-sub">LIMIT + TP + SL</div>
          </div>
          <div class="field">
            <label>Limit Entry Price (USDT)</label>
            <input
              class="price-input"
              type="number"
              id="buy_price"
              placeholder=""
              step="0.01"
              min="1"
              oninput="updatePreview('buy')"
            />
          </div>
          <div class="preview">
            <div class="preview-item">
              <span class="lbl">TAKE PROFIT</span
              ><span class="val tp-val" id="buy_tp">—</span>
            </div>
            <div class="preview-item">
              <span class="lbl">STOP LOSS</span
              ><span class="val sl-val" id="buy_sl">—</span>
            </div>
            <div class="preview-item">
              <span class="lbl">QTY (BTC)</span
              ><span class="val" id="buy_qty">—</span>
            </div>
            <div class="preview-item">
              <span class="lbl">NOTIONAL</span
              ><span class="val" id="buy_notional">—</span>
            </div>
          </div>
          <button class="btn-buy" id="btn-buy" onclick="placeOrder('BUY')">
            ▲ PLACE BUY ORDER
          </button>
        </div>

        <!-- SELL -->
        <div class="card sell">
          <div class="card-header">
            <div class="dot"></div>
            <div class="card-title">SHORT / SELL</div>
            <div class="card-sub">LIMIT + TP + SL</div>
          </div>
          <div class="field">
            <label>Limit Entry Price (USDT)</label>
            <input
              class="price-input"
              type="number"
              id="sell_price"
              placeholder=""
              step="0.01"
              min="1"
              oninput="updatePreview('sell')"
            />
          </div>
          <div class="preview">
            <div class="preview-item">
              <span class="lbl">TAKE PROFIT</span
              ><span class="val tp-val" id="sell_tp">—</span>
            </div>
            <div class="preview-item">
              <span class="lbl">STOP LOSS</span
              ><span class="val sl-val" id="sell_sl">—</span>
            </div>
            <div class="preview-item">
              <span class="lbl">QTY (BTC)</span
              ><span class="val" id="sell_qty">—</span>
            </div>
            <div class="preview-item">
              <span class="lbl">NOTIONAL</span
              ><span class="val" id="sell_notional">—</span>
            </div>
          </div>
          <button class="btn-sell" id="btn-sell" onclick="placeOrder('SELL')">
            ▼ PLACE SELL ORDER
          </button>
        </div>
      </div>

      <!-- Terminal -->
      <div class="terminal-wrap">
        <div class="terminal-header">
          <div class="terminal-title">
            <div class="terminal-dots">
              <span class="d1"></span><span class="d2"></span
              ><span class="d3"></span>
            </div>
            trader@binance-futures ~ /logs
          </div>
          <div class="terminal-controls">
            <div class="status-dot" id="status-dot"></div>
            <div class="status-label" id="status-label">CONNECTED</div>
            <button class="btn-clear" onclick="clearTerminal()">CLEAR</button>
          </div>
        </div>
        <div class="terminal-body" id="terminal">
          {% if initial_logs %} {% for entry in initial_logs %}
          <div class="log-line lvl-{{ entry.level }}">
            <span class="log-ts">{{ entry.ts }}</span>
            <span class="log-lvl lvl-{{ entry.level }}">{{ entry.level }}</span>
            <span class="log-msg">{{ entry.msg }}</span>
          </div>
          {% endfor %} {% else %}
          <div class="terminal-empty" id="empty-msg">
            Waiting for activity...<span class="terminal-caret"></span>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- ══════════ OPEN ORDERS ══════════ -->
      <div class="orders-wrap">
        <div class="orders-header">
          <div class="orders-title">
            OPEN ORDERS
            <span class="orders-count" id="orders-count">0</span>
          </div>
          <button class="btn-refresh" id="btn-refresh" onclick="loadOrders()">
            ↻ REFRESH
          </button>
        </div>
        <div id="orders-body">
          <div class="orders-empty">Loading orders...</div>
        </div>
      </div>

      <footer>
        {{ cfg_symbol }} · USDT-M PERPETUAL · {{ cfg_leverage }}× LEVERAGE ·
        MARK PRICE · closePosition=true
      </footer>
    </div>

    <script>
      const LEVERAGE = {{ cfg_leverage }};
      let AMOUNT    = {{ cfg_amount }};
      let TP_OFFSET = {{ cfg_tp }};
      let SL_OFFSET = {{ cfg_sl }};

      const terminal    = document.getElementById('terminal');
      const statusDot   = document.getElementById('status-dot');
      const statusLabel = document.getElementById('status-label');

      /* ── Settings ── */
      function onSettingChange() {
        const m = parseFloat(document.getElementById('meta-margin').value);
        const t = parseFloat(document.getElementById('meta-tp').value);
        const s = parseFloat(document.getElementById('meta-sl').value);
        if (!isNaN(m) && m > 0) AMOUNT    = m;
        if (!isNaN(t) && t > 0) TP_OFFSET = t;
        if (!isNaN(s) && s > 0) SL_OFFSET = s;
        updatePreview('buy');
        updatePreview('sell');
      }

      function fmt(n, dec=2) {
        return Number(n).toLocaleString('en-US', {minimumFractionDigits:dec, maximumFractionDigits:dec});
      }

      function updatePreview(side) {
        const price = parseFloat(document.getElementById(side+'_price').value);
        if (!price || price <= 0) {
          ['tp','sl','qty','notional'].forEach(k => document.getElementById(side+'_'+k).textContent = '—');
          return;
        }
        const qty = (AMOUNT * LEVERAGE) / price;
        const tp  = side === 'buy' ? price + TP_OFFSET : price - TP_OFFSET;
        const sl  = side === 'buy' ? price - SL_OFFSET : price + SL_OFFSET;
        document.getElementById(side+'_tp').textContent       = '$' + fmt(tp);
        document.getElementById(side+'_sl').textContent       = '$' + fmt(sl);
        document.getElementById(side+'_qty').textContent      = qty.toFixed(5) + ' BTC';
        document.getElementById(side+'_notional').textContent = '$' + fmt(qty * price);
      }

      /* ── AJAX order submission — no page reload ── */
      async function placeOrder(side) {
        const priceEl = document.getElementById(side.toLowerCase() + '_price');
        const price   = parseFloat(priceEl.value);
        if (!price || price <= 0) {
          alert('Please enter a valid limit price.');
          return;
        }
        const qty = (AMOUNT * LEVERAGE) / price;
        const tp  = side === 'BUY' ? price + TP_OFFSET : price - TP_OFFSET;
        const sl  = side === 'BUY' ? price - SL_OFFSET : price + SL_OFFSET;
        const ok  = confirm(
          `Confirm ${side} ORDER\n\n` +
          `Symbol  : BTCUSDT\n` +
          `Margin  : $${fmt(AMOUNT)} USDT\n` +
          `Entry   : $${fmt(price)}\n` +
          `Qty     : ${qty.toFixed(5)} BTC\n` +
          `TP      : $${fmt(tp)}  (+${TP_OFFSET})\n` +
          `SL      : $${fmt(sl)}  (-${SL_OFFSET})\n\nProceed?`
        );
        if (!ok) return;

        /* Disable both buttons while order is running */
        const btnBuy  = document.getElementById('btn-buy');
        const btnSell = document.getElementById('btn-sell');
        btnBuy.disabled  = true;
        btnSell.disabled = true;
        btnBuy.style.opacity  = '0.4';
        btnSell.style.opacity = '0.4';
        const activeBtn = document.getElementById('btn-' + side.toLowerCase());
        activeBtn.textContent = side === 'BUY' ? '▲ PLACING ORDER...' : '▼ PLACING ORDER...';

        const body = new URLSearchParams({
          side:        side,
          limit_price: price,
          margin:      AMOUNT,
          tp_offset:   TP_OFFSET,
          sl_offset:   SL_OFFSET,
        });

        try {
          const res = await fetch('/place-order', { method: 'POST', body });
          const data = await res.json();
          if (data.status === 'started') {
            /* Order thread is running — terminal will show live progress */
            priceEl.value = '';
            updatePreview(side.toLowerCase());
          }
        } catch(e) {
          appendLine({ ts: now(), level: 'ERROR', msg: 'Failed to send order: ' + e });
        } finally {
          btnBuy.disabled  = false;
          btnSell.disabled = false;
          btnBuy.style.opacity  = '1';
          btnSell.style.opacity = '1';
          btnBuy.textContent  = '▲ PLACE BUY ORDER';
          btnSell.textContent = '▼ PLACE SELL ORDER';
        }
      }

      function now() {
        return new Date().toTimeString().slice(0,8);
      }

      /* ── Terminal ── */
      function clearTerminal() {
        terminal.innerHTML = '<div class="terminal-empty" id="empty-msg">Terminal cleared.<span class="terminal-caret"></span></div>';
      }

      function appendLine(entry) {
        const emptyMsg = document.getElementById('empty-msg');
        if (emptyMsg) emptyMsg.remove();
        const line = document.createElement('div');
        line.className = `log-line lvl-${entry.level}`;
        line.innerHTML =
          `<span class="log-ts">${entry.ts}</span>` +
          `<span class="log-lvl lvl-${entry.level}">${entry.level}</span>` +
          `<span class="log-msg">${escHtml(entry.msg)}</span>`;
        terminal.appendChild(line);
        while (terminal.children.length > 200) terminal.removeChild(terminal.firstChild);
        const nearBottom = terminal.scrollHeight - terminal.scrollTop - terminal.clientHeight < 60;
        if (nearBottom) terminal.scrollTop = terminal.scrollHeight;
      }

      function escHtml(str) {
        return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      function connectSSE() {
        const es = new EventSource('/logs/stream');
        es.onopen = () => {
          statusDot.classList.remove('disconnected');
          statusLabel.textContent = 'CONNECTED';
        };
        es.onmessage = (e) => {
          try { appendLine(JSON.parse(e.data)); } catch(_) {}
        };
        es.onerror = () => {
          statusDot.classList.add('disconnected');
          statusLabel.textContent = 'RECONNECTING...';
          es.close();
          setTimeout(connectSSE, 3000);
        };
      }

      connectSSE();
      terminal.scrollTop = terminal.scrollHeight;

      /* ── Open Orders ── */
      async function loadOrders() {
        const btn = document.getElementById('btn-refresh');
        btn.classList.add('spinning');
        btn.disabled = true;
        try {
          const res  = await fetch('/open-orders');
          const data = await res.json();
          renderOrders(data.regular || [], data.algo || []);
        } catch(e) {
          document.getElementById('orders-body').innerHTML =
            '<div class="orders-empty">Failed to load orders.</div>';
        } finally {
          btn.classList.remove('spinning');
          btn.disabled = false;
        }
      }

      function renderOrders(regular, algo) {
        const total = regular.length + algo.length;
        document.getElementById('orders-count').textContent = total;

        if (total === 0) {
          document.getElementById('orders-body').innerHTML =
            '<div class="orders-empty">No open orders for ' + '{{ cfg_symbol }}' + '</div>';
          return;
        }

        let rows = '';

        regular.forEach(o => {
          const side    = o.side || '—';
          const sideClass = side === 'BUY' ? 'side-buy' : 'side-sell';
          const status  = o.status || '—';
          const price   = parseFloat(o.price || 0).toFixed(2);
          const qty     = parseFloat(o.origQty || 0).toFixed(4);
          const filled  = parseFloat(o.executedQty || 0).toFixed(4);
          const type    = o.type || '—';
          rows += `<tr>
            <td><span class="${sideClass}">${side}</span></td>
            <td><span class="type-badge">${type}</span></td>
            <td>$${price}</td>
            <td>${qty}</td>
            <td>${filled}</td>
            <td>${status}</td>
            <td>#${o.orderId}</td>
            <td><button class="btn-cancel" onclick="cancelOrder('${o.orderId}','regular',this)">✕ CANCEL</button></td>
          </tr>`;
        });

        algo.forEach(o => {
          const side      = o.side || '—';
          const sideClass = side === 'BUY' ? 'side-buy' : 'side-sell';
          const price     = parseFloat(o.price || 0).toFixed(2);
          const trigger   = parseFloat(o.triggerPrice || 0).toFixed(2);
          const qty       = parseFloat(o.quantity || 0).toFixed(4);
          const type      = o.orderType || o.type || '—';
          const status    = o.algoStatus || '—';
          rows += `<tr>
            <td><span class="${sideClass}">${side}</span></td>
            <td><span class="type-badge algo">${type}</span></td>
            <td>$${price} <span style="color:var(--muted);font-size:10px">trig:$${trigger}</span></td>
            <td>${qty}</td>
            <td>—</td>
            <td>${status}</td>
            <td>algo#${o.algoId}</td>
            <td><button class="btn-cancel" onclick="cancelOrder('${o.algoId}','algo',this)">✕ CANCEL</button></td>
          </tr>`;
        });

        document.getElementById('orders-body').innerHTML = `
          <div class="orders-table-wrap">
            <table class="orders-table">
              <thead><tr>
                <th>SIDE</th><th>TYPE</th><th>PRICE</th>
                <th>QTY</th><th>FILLED</th><th>STATUS</th><th>ID</th><th></th>
              </tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }

      async function cancelOrder(orderId, type, btn) {
        if (!confirm('Cancel order #' + orderId + '?')) return;
        btn.disabled = true;
        btn.textContent = '...';
        const body = new URLSearchParams({ order_id: orderId, order_type: type });
        try {
          const res  = await fetch('/cancel-order', { method: 'POST', body });
          const data = await res.json();
          if (data.status === 'cancelled') {
            btn.closest('tr').style.opacity = '0.3';
            btn.textContent = '✓';
            setTimeout(loadOrders, 800);
          } else {
            btn.disabled = false;
            btn.textContent = '✕ CANCEL';
            alert('Cancel failed: ' + (data.msg || 'unknown error'));
          }
        } catch(e) {
          btn.disabled = false;
          btn.textContent = '✕ CANCEL';
        }
      }

      // Load orders on page load and after placing an order
      loadOrders();
      setInterval(loadOrders, 10000); // auto-refresh every 10s
    </script>
  </body>
</html>
